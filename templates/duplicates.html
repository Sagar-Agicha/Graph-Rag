<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicate Files</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/transitions.css') }}">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: white;
        }

        .header {
            background: rgba(26, 26, 26, 0.9);
            padding: 1rem;
            border-bottom: 2px solid #ff2233;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
        }

        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 0, 0, 0.3);
        }

        th {
            background: rgba(255, 0, 0, 0.2);
            font-family: 'Orbitron', sans-serif;
        }

        .nested-table {
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.3);
        }

        .nested-table th {
            background: rgba(33, 150, 243, 0.2);
        }

        .action-buttons button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: transform 0.2s;
        }

        .btn-do-not-upload {
            background: #f44336;
            color: white;
        }

        .btn-overwrite {
            background: #FF9800;
            color: white;
        }

        .btn-different-person {
            background: #2196F3;
            color: white;
        }

        .action-buttons button:hover {
            transform: scale(1.05);
        }

        .file-link {
            color: #2196F3;
            text-decoration: underline;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff2233;
            width: 80%;
            max-width: 500px;
        }

        .modal-content button {
            margin-top: 10px;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .modal-content ul {
            list-style: none;
            padding: 0;
        }

        .modal-content ul li {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .cyber-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #ff2233;
        }

        .top-left {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
        }

        .top-right {
            top: -2px;
            right: -2px;
            border-left: none;
            border-bottom: none;
        }

        .bottom-left {
            bottom: -2px;
            left: -2px;
            border-right: none;
            border-top: none;
        }

        .bottom-right {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
        }

        #pdfModal .modal-content {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff2233;
            position: relative;
        }

        #pdfViewer {
            background: white;
            border-radius: 5px;
        }

        .pdf-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-content">
        <h1>Duplicate Files Manager</h1>
        <nav class="nav-links">
            <span>Welcome, {{ username }}</span>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </nav>
    </div>
</header>

<main>
    <div style="position: relative; background: rgba(26, 26, 26, 0.9); padding: 2rem; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);">
        <div class="cyber-corner top-left"></div>
        <div class="cyber-corner top-right"></div>
        <div class="cyber-corner bottom-left"></div>
        <div class="cyber-corner bottom-right"></div>

        <h2>Duplicate Files</h2>
        <table>
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        <span class="file-link" onclick="viewFile('{{ file.uploaded_file.path }}')">{{ file.uploaded_file.name }}</span>
                        <div>
                            <strong>DOB:</strong> {{ file.uploaded_file.dob or 'Not specified' }}
                            <strong>Position:</strong> {{ file.uploaded_file.current_position or 'Not specified' }}
                        </div>
                    </td>
                    <td class="action-buttons">
                        <button class="btn-do-not-upload" onclick="showModal('Do not Upload', '{{ file.uploaded_file.name }}')">Do not Upload</button>
                        <button class="btn-overwrite" onclick="showOverwriteModal('{{ file.uploaded_file.name }}')">Overwrite</button>
                        <button class="btn-different-person" onclick="showModal('Different Person', '{{ file.uploaded_file.name }}')">Different Person</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <table class="nested-table">
                            <thead>
                                <tr>
                                    <th>Duplicates from Database</th>
                                    <th>Similarity</th>
                                    <th>DOB Field</th>
                                    <th>Current Job Role</th>
                                    <th>Current Employer</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for duplicate in file.duplicates %}
                                <tr>
                                    <td><span class="file-link" onclick="viewFile('{{ duplicate.details.pdf_path }}')">{{ duplicate.name }}</span></td>
                                    <td>{{ "%.1f"|format(duplicate.similarity) }}%</td>
                                    <td>{{ duplicate.details.dob or 'Not specified' }}</td>
                                    <td>{{ duplicate.details.current_position or 'Not specified' }}</td>
                                    <td>{{ duplicate.details.current_employer or 'Not specified' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<!-- Modal for General Actions -->
<div id="actionModal" class="modal">
    <div class="modal-content">
        <p id="modalText">Select action</p>
        <button onclick="confirmAction()" style="background: #4CAF50; color: white;">Confirm</button>
        <button onclick="closeModal()" style="background: #f44336; color: white;">Cancel</button>
    </div>
</div>

<!-- Modal for Overwrite Action -->
<div id="overwriteModal" class="modal">
    <div class="modal-content">
        <p id="overwriteText">Select a file to overwrite:</p>
        <ul id="overwriteList"></ul>
        <button onclick="confirmOverwrite()" style="background: #4CAF50; color: white;">Confirm</button>
        <button onclick="closeModal()" style="background: #f44336; color: white;">Cancel</button>
    </div>
</div>

<!-- Add this modal for PDF viewing -->
<div id="pdfModal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 1000px; height: 80vh;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 id="pdfTitle" style="margin: 0;">PDF Viewer</h3>
            <button onclick="closePdfModal()" style="background: #f44336; color: white;">Close</button>
        </div>
        <iframe id="pdfViewer" style="width: 100%; height: calc(100% - 50px); border: none;"></iframe>
    </div>
</div>
<!-- Add before closing body tag -->
<div class="page-transition">
    <div class="transition-line horizontal" style="top: 0"></div>
    <div class="transition-line horizontal" style="bottom: 0"></div>
    <div class="transition-line vertical" style="left: 0"></div>
    <div class="transition-line vertical" style="right: 0"></div>
    <div class="glitch-text">Loading...</div>
</div>

<script>
    // Add this to handle page loads and navigation
    document.addEventListener('DOMContentLoaded', () => {
        const transition = document.querySelector('.page-transition');
        const lines = document.querySelectorAll('.transition-line');
        
        // Only show entry animation if we're not coming from another page
        if (!document.referrer.includes(window.location.host)) {
            transition.classList.add('active');
            lines.forEach(line => line.classList.add('active'));
            
            setTimeout(() => {
                transition.classList.remove('active');
                lines.forEach(line => line.classList.remove('active'));
            }, 1000);
        }
    });

    // Add this to handle navigation links
    document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', (e) => {
            if (!link.hasAttribute('target')) {  // Don't animate if opening in new tab
                e.preventDefault();
                const transition = document.querySelector('.page-transition');
                const lines = document.querySelectorAll('.transition-line');
                
                transition.classList.add('active');
                lines.forEach(line => line.classList.add('active'));
                
                setTimeout(() => {
                    window.location.href = link.href;
                }, 1000);
            }
        });
    });

    function viewFile(filepath) {
        const modal = document.getElementById('pdfModal');
        const viewer = document.getElementById('pdfViewer');
        const title = document.getElementById('pdfTitle');
        
        // Extract filename from path
        const filename = filepath.split('\\').pop();
        
        // Set the title
        title.textContent = `Viewing: ${filename}`;
        
        // Set the source of the iframe, encoding the full path
        viewer.src = `/view_duplicate/${encodeURIComponent(filepath)}`;
        
        // Show the modal
        modal.style.display = 'flex';
    }

    function showModal(action, filename) {
        const modal = document.getElementById('actionModal');
        const modalText = document.getElementById('modalText');
        modalText.innerText = `You selected '${action}' for ${filename}. Are you sure?`;
        modal.style.display = 'flex';
        modal.dataset.filename = filename;
        modal.dataset.action = action;
    }

    function showOverwriteModal(filename) {
        const modal = document.getElementById('overwriteModal');
        const overwriteList = document.getElementById('overwriteList');
        
        // Fetch duplicates from the server
        fetch(`/get_duplicates/${filename}`)
            .then(response => response.json())
            .then(duplicates => {
                overwriteList.innerHTML = '';
                duplicates.forEach(dup => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <input type="radio" name="overwriteFile" value="${dup.name}">
                        ${dup.name} - ${dup.dob || 'No DOB'} - ${dup.role || 'No Role'}
                    `;
                    overwriteList.appendChild(listItem);
                });
                
                modal.style.display = 'flex';
                modal.dataset.filename = filename;
            });
    }

    function closeModal() {
        document.getElementById('actionModal').style.display = 'none';
        document.getElementById('overwriteModal').style.display = 'none';
    }

    function confirmAction() {
        const modal = document.getElementById('actionModal');
        const filename = modal.dataset.filename;
        const action = modal.dataset.action;
        
        let endpoint = '';
        if (action === 'Do not Upload') {
            endpoint = '/delete_duplicate';
        } else if (action === 'Different Person') {
            endpoint = '/process_as_new';
        }

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
        
        closeModal();
    }

    function confirmOverwrite() {
        const modal = document.getElementById('overwriteModal');
        const selectedFile = document.querySelector('input[name="overwriteFile"]:checked');
        
        if (selectedFile) {
            fetch('/overwrite_duplicate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: modal.dataset.filename,
                    selected_id: selectedFile.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        } else {
            alert('Please select a file to overwrite.');
        }
        
        closeModal();
    }

    function closePdfModal() {
        const modal = document.getElementById('pdfModal');
        const viewer = document.getElementById('pdfViewer');
        viewer.src = ''; // Clear the iframe source
        modal.style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const pdfModal = document.getElementById('pdfModal');
        const actionModal = document.getElementById('actionModal');
        const overwriteModal = document.getElementById('overwriteModal');
        
        if (event.target === pdfModal) {
            closePdfModal();
        }
        if (event.target === actionModal || event.target === overwriteModal) {
            closeModal();
        }
    }
</script>

</body>
</html> 